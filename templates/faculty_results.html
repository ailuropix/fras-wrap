{% extends "base.html" %}

{% block title %}{{ data.faculty.name }} - Research Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-white">{{ data.faculty.name }} - Research Analytics</h1>
        <div>
            <small class="text-muted">{{ data.faculty.department }} | {{ data.faculty.college }}</small>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Publications</h5>
                    <h2 class="card-text">{{ data.total_publications if data else 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Citations</h5>
                    <h2 class="card-text">{{ data.total_citations if data else 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white mb-3">
                <div class="card-body">
                    <h5 class="card-title">Last Updated</h5>
                    <h2 class="card-text">{{ data.last_updated.strftime('%m/%d/%Y') if data and data.last_updated else 'Just now' }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white mb-3">
                <div class="card-body">
                    <h5 class="card-title">H-Index</h5>
                    <h2 class="card-text">{{ (data.total_citations / data.total_publications)|round(1) if data and data.total_publications > 0 else 0 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Publications -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Top Publications</h4>
                </div>
                <div class="card-body p-0">
                <div id="topPublications">
                    {% if data and data.top_publications %}
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 35%">Title</th>
                                        <th style="width: 25%">Authors</th>
                                        <th style="width: 20%">Journal</th>
                                        <th style="width: 8%">Year</th>
                                        <th style="width: 7%">Citations</th>
                                        <th style="width: 5%">DOI</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pub in data.top_publications %}
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-white" style="font-size: 0.9rem;">{{ pub.title }}</div>
                                        </td>
                                        <td>
                                            <small class="text-light">{{ pub.authors }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ pub.journal }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ pub.year }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ pub.citations }}</span>
                                        </td>
                                        <td>
                                            {% if pub.doi %}
                                            <a href="https://doi.org/{{ pub.doi }}" target="_blank" class="text-info" title="{{ pub.doi }}">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">No publications found for {{ data.faculty.name }}</p>
                            <small class="text-muted">Try searching again or check the faculty name spelling</small>
                        </div>
                    {% endif %}
                </div>
            </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Publication Trends</h4>
            </div>
            <div class="card-body">
                <div id="trendChart"></div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-primary me-2">Search Another Faculty</a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">View System Dashboard</a>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script type="application/json" id="trend-data">
{% if data and data.publication_trends %}
{{ data.publication_trends | tojson | safe }}
{% else %}
[]
{% endif %}
</script>
<script>
// Create publication trends chart
const trendData = JSON.parse(document.getElementById('trend-data').textContent);
if (trendData && trendData.length > 0) {
    const years = trendData.map(d => d.year);
    const counts = trendData.map(d => d.count);
    const citations = trendData.map(d => d.citations);

    const trace1 = {
        x: years,
        y: counts,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Publications',
        line: { color: '#007bff' }
    };

    const trace2 = {
        x: years,
        y: citations,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Citations',
        yaxis: 'y2',
        line: { color: '#28a745' }
    };

    const layout = {
        title: 'Publication and Citation Trends',
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: 'white' },
        xaxis: { 
            title: 'Year',
            color: 'white',
            gridcolor: 'rgba(255,255,255,0.2)'
        },
        yaxis: { 
            title: 'Publications',
            color: 'white',
            gridcolor: 'rgba(255,255,255,0.2)'
        },
        yaxis2: {
            title: 'Citations',
            overlaying: 'y',
            side: 'right',
            color: 'white'
        },
        legend: { 
            font: { color: 'white' },
            bgcolor: 'rgba(0,0,0,0.5)'
        }
    };

    Plotly.newPlot('trendChart', [trace1, trace2], layout, {responsive: true});
} else {
    document.getElementById('trendChart').innerHTML = '<p class="text-center text-muted">No trend data available</p>';
}
</script>
{% endblock %}
